---
title: Spring Entity Mapping
date: 2025-04-09
desc: Spring Framework (6)
thumbnail: /posts/Backend/2025-04-09/thumbnail.png
tags:
  - Spring
  - Web Framework
  - JPA
seriesName: Spring Framework
---

<Thumbnail src="/posts/Backend/2025-04-09/thumbnail.png" />
<Callout type="warn">**êµê³¼ëª© ë‚´ìš©ì„ ì •ë¦¬í•˜ê¸° ìœ„í•œ ê¸€ì…ë‹ˆë‹¤. í‹€ë¦° ë‚´ìš©ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì„¸ìš”**</Callout>

## Entity Relationships

> ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” ë§ì€ í…Œì´ë¸”, í…Œì´ë¸”ê°„ ì—¬ëŸ¬ ê´€ê³„ë¥¼ ê°€ì§

ì´ê²ƒì„ JPA/Hibernateë¡œ ì„¤ê³„ í•´ì•¼í•¨

ê´€ê³„ì˜ ë‹¤ì¤‘ì„±ì—ëŠ” **ë„¤ ê°€ì§€** ìœ í˜•ì´ ìˆìŒ
- `@OneToOne`
- `@OneToMany`, `@ManyToOne`
- `@ManyToMany`

ê´€ê³„ì˜ ë°©í–¥ì€ ë‹¤ìŒê³¼ ê°™ì„ ìˆ˜ ìˆìŒ
- ì–‘ë°©í–¥(bidirectional) : ì£¼ì¸ ìª½(owning side)ê³¼ ë°˜ëŒ€ ìª½(inverse side)ì´ ì¡´ì¬í•¨
- ë‹¨ë°©í–¥(unidirectional) : ì£¼ì¸ ìª½(owning side)ë§Œ ì¡´ì¬í•¨

ì£¼ì¸ ìª½(owning side)ì€ **ì°¸ì¡°ë¥¼ í…Œì´ë¸”ì— ì‹¤ì œë¡œ ì €ì¥í•˜ëŠ” ì—”í„°í‹°** ì¦‰ <Highlight color="SKY">**ì™¸ë˜ í‚¤(foreign key)ë¥¼ ê°€ì§„ í…Œì´ë¸”**</Highlight>


## Entity Relation Attributes
```java
@OneToMany(cascade = CascadeType.ALL, fetch = FetchType.LAZY)
```

**Cascading ì—…ë°ì´íŠ¸/ì‚­ì œ**
- ì—°ê´€ëœ ì—”í„°í‹°ì— ë™ì¼í•œ ì‘ì—…ì„ ì ìš©í•¨
- CascadeType: `ALL`, `PERSIST`, `MERGE`, `REMOVE`, `REFRESH`

| Cascade Type   | ì„¤ëª…                                               | ì ìš©ë˜ëŠ” ì‘ì—…                                |
|----------------|----------------------------------------------------|---------------------------------------------|
| **ALL**        | ëª¨ë“  ì‘ì—…(ì €ì¥, ì—…ë°ì´íŠ¸, ì‚­ì œ ë“±)ì´ ìì‹ ì—”í‹°í‹°ì— ì „íŒŒë¨. | ë¶€ëª¨ì˜ `persist`, `merge`, `remove`, `refresh`, `detach` ì‘ì—… ëª¨ë‘ ìì‹ ì—”í‹°í‹°ì— ì „íŒŒ (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì ìš©) |
| **PERSIST**    | ë¶€ëª¨ ì—”í‹°í‹°ê°€ ì˜ì†í™”(persist)ë  ë•Œ ìì‹ ì—”í‹°í‹°ë„ ì˜ì†í™”ë¨. | ë¶€ëª¨ì˜ `persist` ì‘ì—…ì´ ìì‹ ì—”í‹°í‹°ì— ì „íŒŒë¨ (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì ìš©)  |
| **MERGE**      | ë¶€ëª¨ ì—”í‹°í‹°ê°€ ë³‘í•©(merge)ë  ë•Œ ìì‹ ì—”í‹°í‹°ë„ ë³‘í•©ë¨.    | ë¶€ëª¨ì˜ `merge` ì‘ì—…ì´ ìì‹ ì—”í‹°í‹°ì— ì „íŒŒë¨ (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì ìš©)    |
| **REMOVE**     | ë¶€ëª¨ ì—”í‹°í‹°ê°€ ì‚­ì œ(remove)ë  ë•Œ ìì‹ ì—”í‹°í‹°ë„ ì‚­ì œë¨.  | ë¶€ëª¨ì˜ `remove` ì‘ì—…ì´ ìì‹ ì—”í‹°í‹°ì— ì „íŒŒë¨ (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì ìš©)   |
| **REFRESH**    | ë¶€ëª¨ ì—”í‹°í‹°ê°€ ìƒˆë¡œ ê³ ì¹¨(refresh)ë  ë•Œ ìì‹ ì—”í‹°í‹°ë„ ìƒˆë¡œ ê³ ì¹¨ë¨. | ë¶€ëª¨ì˜ `refresh` ì‘ì—…ì´ ìì‹ ì—”í‹°í‹°ì— ì „íŒŒë¨ (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì ìš©)  |
| **DETACH**     | ë¶€ëª¨ ì—”í‹°í‹°ê°€ ë¶„ë¦¬(detach)ë  ë•Œ ìì‹ ì—”í‹°í‹°ë„ ë¶„ë¦¬ë¨.  | ë¶€ëª¨ì˜ `detach` ì‘ì—…ì´ ìì‹ ì—”í‹°í‹°ì— ì „íŒŒë¨ (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì ìš©)   |


â€» ê¸°ë³¸ì ìœ¼ë¡œëŠ” **ì–´ë– í•œ ì‘ì—…ë„ ì—°ì‡„ë˜ì§€ ì•ŠìŒ**

**ì—°ê´€ëœ ì—”í„°í‹°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì „ëµ(Fetching strategy)**
- FetchType: `LAZY`, `EAGER`
- **EAGER**ëŠ” **ëª¨ë“  ê²ƒì„ í•œ ë²ˆì—** ê°€ì ¸ì˜µë‹ˆë‹¤. **ì„±ëŠ¥ ë¬¸ì œ**ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŒ
- **LAZY**ëŠ” **ìš”ì²­ ì‹œ**ì—ë§Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

â€» ì¦‰, í”„ë¡œí¼í‹°ì— ì ‘ê·¼í•  ë•Œê¹Œì§€ í•´ë‹¹ í–‰(row)ì„ ë¡œë“œí•˜ì§€ ì•ŠìŒ

| Mapping | Default Fetch Type |
| --- | --- |
| `@OneToOne` | FetchType.EAGER |
| `@OneToMany` | **FetchType.LAZY** |
| `@ManyToOne` | FetchType.EAGER |
| `@ManyToMany` | **FetchType.LAZY** |

> Manyê°€ í¬í•¨ë˜ë©´ FetchType.LAZYê°€ Default

### 1. OneToMany Unidirectional

í•œ ê°•ì‚¬ëŠ” ì—¬ëŸ¬ ê°•ì˜ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.

```md caption="OneToMany"
                          +----------+
                    * --- |  Course  |
                    |     +----------+
                    |
+-------------+     |     +----------+
| Instructor  | <-- + --- |  Course  |
+-------------+     |     +----------+
                    |
                    |     +----------+
                    * --- |  Course  |
                          +----------+
```

```java title="instructor"
@Entity
@Table(name="instructor")
public class Instructor {
  @Id
  @GeneratedValue
  @Column(name="id")
  private Long id;

  @Column(name="full_name")
  private String fullName;

  @Column(name="email")
  private String email;
}
```

```java title="course" {12-14}
@Entity
@Table(name="course")
public class Course {
  @Id
  @GeneratedValue
  @Column(name="id")
  private Long id;

  @Column(name="title")
  private String title;

  @ManyToOne
  @JoinColumn(name="instructor_id")
  private Instructor instructor;
}
```

1. ì¼ëŒ€ë‹¤(One-to-Many) ê´€ê³„ì—ì„œëŠ” ì™¸ë˜ í‚¤(Foreign Key)ê°€ í•­ìƒ â€œManyâ€ ìª½ì— ì¡´ì¬
2. `@ManyToOne` ì• ë„ˆí…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ JPA/Hibernateì—ê²Œ ì–´ë–¤ ê°ì²´ê°€ **ìì‹ ê°ì²´**ì¸ì§€ ì•Œë ¤ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. `@OneToMany` ì• ë„ˆí…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ JPA/Hibernateì—ê²Œ ì–´ë–¤ ê°ì²´ê°€ **ë¶€ëª¨ ê°ì²´**ì¸ì§€ ì•Œë ¤ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
4. `@JoinColumn` ì• ë„ˆí…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´, **ì–´ë–¤ ì»¬ëŸ¼ì„ ì¡°ì¸ì— ì‚¬ìš©**í• ì§€ ëª…ì‹œí•  ìˆ˜ ìˆìœ¼ë©°, **í•´ë‹¹ ì»¬ëŸ¼ì˜ ì´ë¦„ë„ ì§€ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

â€» ì¦‰, ë¶€ëª¨ í…Œì´ë¸”(instructor), ìì‹ í…Œì´ë¸”(course) ì¤‘ì—ì„œ, **ìì‹ í…Œì´ë¸”ì´ ì™¸ë˜ í‚¤ë¥¼ ê°€ì§**

```java title="CourseDao"
@Repository
@Transactional
public class CourseDao {
  @PersistenceContext
  private EntityManager entityManager;

  public void save(Course course) {
    entityManager.persist(course);
  }

  public Course findById(Long id) {
    return entityManager.find(Course.class, id);
  }

  public List<Course> findAll() {
    return entityManager.createQuery("SELECT c FROM Course c", Course.class).getResultList();
  }
}
```

```java title="InstructorDao"
@Repository
@Transactional
public class InstructorDao {
  @PersistenceContext
  private EntityManager entityManager;

  public void save(Instructor instructor) {
    entityManager.persist(instructor);
  }

  public Instructor findById(Long id) {
    return entityManager.find(Instructor.class, id);
  }

  public List<Instructor> findAll() {
    return entityManager.createQuery("SELECT i FROM Instructor i", Instructor.class).getResultList();
  }
}
```

```java title="main"
// [1] Instructor ê°ì²´ ìƒì„±
Instructor instructor1 = new Instructor("Namyun Kim", "nykim@hansung.ac.kr");
Instructor instructor2 = new Instructor("Jaemon Lee", "jmlee@hansung.ac.kr");

// [2] Instructor ë¨¼ì € ì €ì¥ (DBì— insert + id ìƒì„±)
instructorDao.save(instructor1);
instructorDao.save(instructor2);

// [3] Course ê°ì²´ ìƒì„±
Course course1 = new Course("ì›¹í”„ë ˆì„ì›Œí¬");
Course course2 = new Course("ì˜¤í”ˆì†ŒìŠ¤ì†Œí”„íŠ¸ì›¨ì–´");
Course course3 = new Course("iOS í”„ë¡œê·¸ë˜ë°");
Course course4 = new Course("ì•ˆë“œë¡œì´ë“œ í”„ë¡œê·¸ë˜ë°");

// [4] ê° Courseì— Instructor ì„¤ì • (ì—°ê´€ê´€ê³„ ì£¼ì…)
course1.setInstructor(instructor1);
course2.setInstructor(instructor1);
course3.setInstructor(instructor2);
course4.setInstructor(instructor2);

// [5] Course ì €ì¥ (instructor_id í¬í•¨ëœ ìƒíƒœë¡œ INSERT)
courseDao.save(course1);
courseDao.save(course2);
courseDao.save(course3);
courseDao.save(course4);
```

### 2. OneToMany Bidirectional

1. ê°ì²´ ê°„ì— ì–‘ë°©í–¥(bidirectional) ê´€ê³„ê°€ ìˆì„ ë•Œ, **ë‘ ê°ì²´ëŠ” ì„œë¡œ ì ‘ê·¼**í•  ìˆ˜ ìˆë‹¤.
2. ì–‘ë°©í–¥ ê´€ê³„ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´, ê¸°ì¡´ì˜ **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€**í•  ìˆ˜ ìˆìŒ

â€» ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ X, ë‹¨ì§€ Java ì½”ë“œë§Œ ì—…ë°ì´íŠ¸

```java title="Instructor"
@Entity
@Table(name="instructor")
public class Instructor {  
  â€¦
  @OneToMany(mappedBy = "instructor",fetch = FetchType.LAZY,  cascade=CascadeType.ALL)
  private List<Course> courses = new ArrayList<>();
  
  // ì—°ê´€ ê´€ê³„ í¸ì˜ ë©”ì†Œë“œ
  public void addCourse(Course course) {
    courses.add(course);
    course.setInstructor(this);
  }
}
```

<Callout type="info"><Highlight color="PEACH">**mappedBy**</Highlight>ëŠ” JPA/Hibernateì— Instructorì™€ ì—°ê´€ëœ Courseë“¤ì„ ì°¾ì„ ë•ŒëŠ”, Course í´ë˜ìŠ¤ì— ìˆëŠ” `instructor` ì†ì„±ì„ ì°¸ê³ í•˜ë¼ ì•Œë¦¼</Callout>

```java title="Instructor" {3-4}
public class Instructor {
  ...
  @OneToMany(mappedBy="Instructor")
  private List<Course> courses;
}
```

```java title="Course" {5}
public class Course{
  ...
  @ManyToOne
  @JoinColumn(name="instructor_Id")
  private Instructor instructor
}
```

> ì´ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì€ Course ìª½ì˜ instructor í•„ë“œ

```java {5-6} caption="Exception in thread "main" org.hibernate.LazyInitializationException ğŸš¨"
Instructor instructor1 = new Instructor("Namyun Kim", "nykim@hansung.ac.kr");
Course course1 = new Course("ì›¹í”„ë ˆì„ì›Œí¬");
Course course2 = new Course("ì˜¤í”ˆì†ŒìŠ¤ì†Œí”„íŠ¸ì›¨ì–´");

instructor1.addCourse(course1);
instructor1.addCourse(course2);

// cascade=CascadeType.ALL, fetch = FetchType.LAZY
instructorDao.save(instructor1);

// ì €ì¥ëœ Instructor ì¡°íšŒ ë° ê²°ê³¼ í™•ì¸
Instructor retrievedInstructor = instructorDao.findById(instructor1.getId());
System.out.println("Instructor: " + retrievedInstructor.getFullName());

for (Course Course : retrievedInstructor.getCourses()) {
    System.out.println("Course: " + Course.getTitle());
}
```

<Callout type="danger">`@Transactional`ì´ ëë‚˜ë©´ EntityManager(DB ì—°ê²°)ê°€ ë‹«íˆê¸°ì— `ì§€ì—°ë¡œë”©(LAZY)`ëœ ì—°ê´€ ê°ì²´ëŠ” ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŒ</Callout>

```java title="InstructorDao" caption="ìš°íšŒ ë°©ë²• ğŸ¦„" {5}
@Transactional
public Instructor findByIdWithCourses(Long id) {
  Instructor instructor = entityManager.find(Instructor.class, id);
  if (instructor != null) {
      instructor.getCourses().size(); // ì»¬ë ‰ì…˜ ë¡œë“œ
  }
  return instructor;
}
```

#### ëª¨ë“  ê°ì²´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ìœ ì§€í•˜ëŠ” ë°©ë²•
1. ë¶€ëª¨ ê°ì²´ë¥¼ ìƒì„±
2. ìì‹ ê°ì²´ë“¤ì„ ìƒì„±
3. ìì‹ ê°ì²´ë“¤ì— ë¶€ëª¨ ê°ì²´ë¥¼ ì„¤ì •
4. ë¶€ëª¨ ê°ì²´ì— ìì‹ ê°ì²´ë“¤ì˜ ëª¨ìŒì„ ì„¤ì •
5. ë¶€ëª¨ ê°ì²´ë¥¼ ì €ì¥


### 3. OneToOne Unidirectional

```md caption="One To One"
+-------------+           +--------------------+
| Instructor  | --------> |  InstructorDetail  |
+-------------+           +--------------------+
```

```java title="InstructorDetail"
@Entity
@Table(name="instructor_detail")
public class InstructorDetail {
  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  @Column(name = "id")
  private int id;

  @Column(name = "youtube_channel")
  private String youtubeChannel;

  @Column(name = "hobby")
  private String hobby;
}
```


```java title="Instructor" {11-13}
@Entity
@Table(name="instructor")
public class Instructor {
  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  @Column(name="id")
  private Long id;

  â€¦

  @OneToOne(cascade = CascadeType.ALL)
  @JoinColumn(name = "instructor_detail_id")
  private InstructorDetail instructorDetail;
}
```

### 4. ManyToMany Unidirectional

##### í•™ìƒì€ ë§ì€ ìˆ˜ì—…ì„ ê°€ì§ˆ ìˆ˜ ìˆê³  ìˆ˜ì—…ë„ ë§ì€ í•™ìƒì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.

![Many To Many](/posts/Backend/2025-04-09/1.png)

> Join Tableì„ ë‘ê³  ê´€ê³„ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ íš¨ìœ¨ì 

#### ì¡°ì¸ í…Œì´ë¸” (Join Table) 

![Many To Many](/posts/Backend/2025-04-09/2.png)

- ë‹¤ëŒ€ë‹¤(Many-to-Many) ê´€ê³„ë¥¼ ìœ„í•œ ì¢‹ì€ ì„¤ê³„ëŠ” <Highlight color="LAVENDER">**ì¡°ì¸ í…Œì´ë¸”**</Highlight>ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒ
- **ì¡°ì¸ í…Œì´ë¸”**ì´ë¼ëŠ” ìš©ì–´ëŠ” **ë‘ í…Œì´ë¸”ì˜ ê¸°ë³¸ í‚¤(primary key)ë§Œ ì €ì¥í•˜ëŠ” ì„¸ ë²ˆì§¸ SQL í…Œì´ë¸”ì„ ì„¤ëª…í•˜ëŠ” ë°©ë²•**
- ê´€ë¡€ìƒ, ì´ ì¡°ì¸ í…Œì´ë¸”ì˜ ì´ë¦„ì€ ì¼ë°˜ì ìœ¼ë¡œ ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ ë§ºëŠ” ë‘ í…Œì´ë¸”ì˜ ì´ë¦„ì„ ê²°í•©í•œ í˜•íƒœ ex) course_student
- ì´ ì¡°ì¸ í…Œì´ë¸”ì€ **course í…Œì´ë¸”**ê³¼ **student í…Œì´ë¸”**ì—ì„œ **ê¸°ë³¸ í‚¤ë§Œ í¬í•¨**

```java {6-12} title="Student"
@Entity
@Table(name = "student")
public class Student {
  ...

  @ManyToMany
  @JoinTable(
    name = "student_course",
    joinColumns = @JoinColumn(name = "student_id"),
    inverseJoinColumns = @JoinColumn(name = "course_id")
  )
  private List<Course> courses;
}
```

### ì „ì²´ êµ¬ì¡°

![Architecture](/posts/Backend/2025-04-09/3.png)